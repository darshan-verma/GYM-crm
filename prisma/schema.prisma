// Pro Bodyline Fitness CRM - Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TRAINER
  RECEPTIONIST
  HELPER
  CUSTOM
}

enum Permission {
  // Dashboard access
  VIEW_DASHBOARD
  
  // Member management
  VIEW_MEMBERS
  CREATE_MEMBERS
  EDIT_MEMBERS
  DELETE_MEMBERS
  
  // Billing and payments
  VIEW_BILLING
  CREATE_PAYMENTS
  EDIT_PAYMENTS
  VIEW_INVOICES
  CREATE_INVOICES
  
  // Workout management
  VIEW_WORKOUTS
  CREATE_WORKOUTS
  EDIT_WORKOUTS
  DELETE_WORKOUTS
  
  // Diet management
  VIEW_DIETS
  CREATE_DIETS
  EDIT_DIETS
  DELETE_DIETS
  
  // Attendance
  VIEW_ATTENDANCE
  MARK_ATTENDANCE
  
  // Leads
  VIEW_LEADS
  CREATE_LEADS
  EDIT_LEADS
  
  // Reports
  VIEW_REPORTS
  
  // Staff management (only for admins)
  VIEW_STAFF
  CREATE_STAFF
  EDIT_STAFF
  DELETE_STAFF
  
  // Settings (only for admins)
  VIEW_SETTINGS
  EDIT_SETTINGS
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  PENDING
}

enum PaymentMode {
  CASH
  ONLINE
  UPI
  CARD
  BANK_TRANSFER
}

enum LeadStatus {
  NEW
  CONTACTED
  FOLLOW_UP
  CONVERTED
  LOST
}

enum LeadSource {
  WALK_IN
  PHONE_CALL
  WEBSITE
  SOCIAL_MEDIA
  REFERRAL
  OTHER
}

enum NotificationType {
  EMAIL
  SMS
  WHATSAPP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum InAppNotificationType {
  LEAD_FOLLOW_UP
  PAYMENT_DUE
  MEMBERSHIP_EXPIRING
  NEW_MEMBER
}

enum InAppNotificationStatus {
  UNREAD
  READ
  DISMISSED
}

model Role {
  id                 String       @id @default(cuid())
  name               String       @unique
  description        String?
  defaultPermissions Permission[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  users User[]
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String
  role         UserRole @default(RECEPTIONIST)
  customRoleId String?
  customRole   Role?    @relation(fields: [customRoleId], references: [id], onDelete: SetNull)
  permissions  Permission[]
  phone        String?
  avatar       String?
  active       Boolean  @default(true)
  lastLogin    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  trainedMembers Member[]      @relation("TrainerMembers")
  activityLogs   ActivityLog[]

  @@index([email])
  @@index([role])
}

model Member {
  id                 String            @id @default(cuid())
  membershipNumber   String            @unique
  name               String
  email              String?
  phone              String
  address            String?
  city               String?
  state              String?
  pincode            String?
  latitude           Decimal?  @db.Decimal(10, 8)
  longitude          Decimal?  @db.Decimal(11, 8)
  formattedAddress   String?
  dateOfBirth        DateTime?
  gender             String?
  photo              String?
  emergencyContact   String?
  emergencyName      String?
  bloodGroup         String?
  medicalConditions  String?
  joiningDate        DateTime          @default(now())
  status             MembershipStatus  @default(PENDING)
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  trainerId String?
  trainer   User?   @relation("TrainerMembers", fields: [trainerId], references: [id], onDelete: SetNull)

  memberships  Membership[]
  payments     Payment[]
  attendance   Attendance[]
  workoutPlans WorkoutPlan[]
  dietPlans    DietPlan[]

  @@index([phone])
  @@index([status])
  @@index([trainerId])
  @@index([createdAt])
}

model MembershipPlan {
  id          String   @id @default(cuid())
  name        String
  description String?
  duration    Int // in days
  price       Decimal  @db.Decimal(10, 2)
  features    Json? // ["Gym Access", "Locker", "Trainer"]
  color       String? // for UI color coding
  popular     Boolean  @default(false)
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships Membership[]

  @@index([active])
}

model Membership {
  id           String   @id @default(cuid())
  memberId     String
  planId       String
  startDate    DateTime @default(now())
  endDate      DateTime
  amount       Decimal  @db.Decimal(10, 2)
  discount     Decimal? @db.Decimal(10, 2)
  discountType String? // PERCENTAGE or FIXED
  finalAmount  Decimal  @db.Decimal(10, 2)
  active       Boolean  @default(true)
  autoRenew    Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  member Member         @relation(fields: [memberId], references: [id], onDelete: Cascade)
  plan   MembershipPlan @relation(fields: [planId], references: [id])

  @@index([memberId])
  @@index([planId])
  @@index([endDate])
  @@index([active])
}

model Payment {
  id              String      @id @default(cuid())
  memberId        String
  amount          Decimal     @db.Decimal(10, 2)
  paymentMode     PaymentMode
  paymentDate     DateTime    @default(now())
  transactionId   String?
  invoiceNumber   String      @unique
  referenceNumber String?
  notes           String?
  receiptPath     String?
  gstNumber       String?
  gstPercentage   Decimal?    @db.Decimal(5, 2)
  gstAmount       Decimal?    @db.Decimal(10, 2)
  discount        Decimal?    @db.Decimal(10, 2)
  nextDueAmount   Decimal?    @db.Decimal(10, 2)
  nextDueDate     DateTime?
  createdBy       String?
  createdAt       DateTime    @default(now())

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([paymentDate])
  @@index([invoiceNumber])
}

model Attendance {
  id       String    @id @default(cuid())
  memberId String
  checkIn  DateTime  @default(now())
  checkOut DateTime?
  date     DateTime  @default(now()) @db.Date
  duration Int? // in minutes
  notes    String?

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, date])
  @@index([date])
  @@index([memberId])
}

model Lead {
  id              String      @id @default(cuid())
  name            String
  phone           String
  email           String?
  age             Int?
  gender          String?
  source          LeadSource  @default(WALK_IN)
  status          LeadStatus  @default(NEW)
  interestedPlan  String?
  budget          Decimal?    @db.Decimal(10, 2)
  preferredTime   String?
  notes           String?
  followUpDate    DateTime?
  lastContactDate DateTime?
  convertedDate   DateTime?
  assignedTo      String?
  priority        String? // HIGH, MEDIUM, LOW
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([status])
  @@index([source])
  @@index([followUpDate])
  @@index([createdAt])
}

model WorkoutPlan {
  id          String   @id @default(cuid())
  memberId    String
  name        String
  description String?
  exercises   Json // [{name, sets, reps, weight, restTime, notes, videoUrl}]
  difficulty  String? // BEGINNER, INTERMEDIATE, ADVANCED
  goalId      String?
  startDate   DateTime @default(now())
  endDate     DateTime?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  goal   FitnessGoal? @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([memberId])
  @@index([active])
  @@index([goalId])
}

model DietPlan {
  id            String   @id @default(cuid())
  memberId      String
  name          String
  description   String?
  goal          String?
  meals         Json // [{mealTime, items, calories, protein, carbs, fats, notes}]
  totalCalories Int?
  totalProtein  Int?
  dietTypeId    String?
  startDate     DateTime @default(now())
  endDate       DateTime?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  member   Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  dietType DietType? @relation(fields: [dietTypeId], references: [id], onDelete: SetNull)

  @@index([memberId])
  @@index([active])
  @@index([dietTypeId])
}

model FitnessGoal {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isDefault   Boolean  @default(false) // Predefined goals cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workoutPlans WorkoutPlan[]

  @@index([name])
}

model Notification {
  id        String             @id @default(cuid())
  type      NotificationType
  recipient String
  subject   String?
  message   String
  status    NotificationStatus @default(PENDING)
  error     String?
  sentAt    DateTime?
  createdAt DateTime           @default(now())

  @@index([status])
  @@index([createdAt])
  @@index([type])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String // CREATE, UPDATE, DELETE, LOGIN
  entity    String // Member, Payment, Lead, etc.
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt

  @@index([key])
}

model GymProfile {
  id          String   @id @default(cuid())
  name        String
  description String?
  address     String?
  phone       String?
  email       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

model DietType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isDefault   Boolean  @default(false) // Predefined types cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dietPlans DietPlan[]

  @@index([name])
}

model Food {
  id          String   @id @default(cuid())
  name        String   @unique
  calories    Int
  protein     Decimal  @db.Decimal(5, 2)
  carbs       Decimal  @db.Decimal(5, 2)
  fat         Decimal  @db.Decimal(5, 2)
  category    String
  isDefault   Boolean  @default(false) // Predefined foods cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([category])
}

model Exercise {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String
  equipment   String
  difficulty  String   // BEGINNER, INTERMEDIATE, ADVANCED
  isDefault   Boolean  @default(false) // Predefined exercises cannot be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([category])
}

model InAppNotification {
  id          String                   @id @default(cuid())
  type        InAppNotificationType
  title       String
  message     String
  entityType  String // Lead, Member, Payment
  entityId    String?
  status      InAppNotificationStatus  @default(UNREAD)
  metadata    Json? // Additional data like expiry date, amount, etc.
  createdAt   DateTime                 @default(now())
  readAt      DateTime?
  dismissedAt DateTime?

  @@index([status])
  @@index([type])
  @@index([entityType, entityId])
  @@index([createdAt])
}
